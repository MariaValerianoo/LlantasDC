create database dbtionline;
use dbtionline;

create table cliente(
    idcliente int auto_increment primary key not null,
    nombrecliente varchar(15) null,
    apellidocliente varchar(15) null,
    direccioncliente varchar(15) null,
    telefono int(10) null,
    fechanacimiento date
);

create table usuario (
    idusuario int auto_increment primary key,
    cedulausuario int not null,
    nombreusuario varchar(50),
    apellidousuario varchar(50),
    direccionusuario varchar(100),
    telefono varchar(15),
    rolusuario varchar(50)
);

create table venta(
    idventas int (15) not null,
    numorden varchar(15) primary key not null,
    fechacompra date not null,
    totalcompra int not null,
    idusuariofk int not null,
    idclientefk int not null
);

create table producto(
    idproducto int (15) not null,
    codigobarras varchar(15) primary key not null,
    nombreproducto varchar(15) not null,
    marca varchar(15) not null,
    precio float not null
);

create table prodven(
    numordenfk varchar(15) not null,
    codigobarrasfk varchar(18) not null,
    cantidad int not null
);

alter table venta
add constraint ventasar
foreign key(idusuariofk)
references usuario(idusuario);

alter table venta
add constraint ventaclie
foreign key(idclientefk)
references cliente(idcliente);

alter table prodven
add constraint fkprodventa
foreign key(numordenfk)
references venta(numorden);

alter table prodven
add constraint prodvenk
foreign key(codigobarrasfk)
references producto(codigobarras);

insert into cliente (nombrecliente, apellidocliente, direccioncliente, telefono, fechanacimiento) 
values ('juan', 'pérez', 'calle 1', 3001234567, '1985-01-10'),
       ('ana', 'gómez', 'calle 2', 3007654321, '1990-05-25'),
       ('pedro', 'martínez', 'calle 3', 3001122334, '1978-01-30'),
       ('luisa', 'fernández', 'calle 4', 3009988776, '2001-09-12');

insert into usuario (cedulausuario, nombreusuario, apellidousuario, direccionusuario, telefono, rolusuario) 
values (1028481760, 'mafe', 'valeriano', 'calle 10', '3101234567', 'empleado'),
       (52537135, 'ruth', 'pulido', 'calle 15', '3173613339', 'empleado'),
       (1023456789, 'carlos', 'lópez', 'calle 20', '3123456789', 'administrador'),
       (1087654321, 'maría', 'rodríguez', 'calle 25', '3198765432', 'empleado');

insert into producto (codigobarras, nombreproducto, marca, precio) 
values ('45hg', 'jabón', 'suavitel', 10000),
       ('45jh', 'detergente', 'ak', 15000),
       ('89kq', 'shampoo', 'head & shoulders', 25000),
       ('12rw', 'cepillo', 'oral-b', 5000);

insert into venta (numorden, fechacompra, totalcompra, idusuariofk, idclientefk) 
values ('ord001', '2023-03-15', 35000, 1, 1),
       ('ord002', '2023-04-20', 25000, 2, 2),
       ('ord003', '2023-06-05', 45000, 1, 3),
       ('ord004', '2023-07-10', 30000, 3, 4);

insert into prodven (numordenfk, codigobarrasfk, cantidad) 
values ('ord001', '45hg', 2),
       ('ord002', '45jh', 1),
       ('ord003', '89kq', 2),
       ('ord004', '12rw', 3);
       
select * from producto;

/*ordenar productos por precio de menor a mayor*/
select * from producto order by precio asc;

/*consultar los clientes que nacen en enero*/
select * from cliente where idcliente in ('1', '3');

/* consultar los usuarios con el rol de empleado*/
select * from usuario where nombrecliente like '%mafe%' or nombrecliente like '%ruth%' or nombrecliente like '%maría%';

/*consultar las órdenes generadas entre marzo y junio*/
select * from venta where fechacompra between '2023-03-01' and '2023-06-30';

/*consultar productos que contengan la letra 'r'*/
select * from producto where nombreproducto like '%r%';

/*consultar las ventas que tengan productos con precios entre 15.000 y 30.000*/
/*select v. *
from venta v 
join prclienteodven pv on v.numorden = pv.numordenfk
join producto p on pv.codigobarrasfk = p.codigobarras where p.precio between 15000 and 30000;*/

alter table Producto add cantidadProducto int;
alter table Venta add CantidadUnitaria int;
alter table Prodven add Total int;

/*Consulta multitablas*/
select * from Venta inner join Cliente on Venta.idClienteFK = Cliente.idCliente;

/* select masctoa.*, cliente.nombreCliente from mascota inner join on mascota.idmascota=cliente.idmascotafk*/
/* select m.*, c.nombreCliente
from Mascota m
inner join cliente c on m.idmascota=c.idmascotafk*/

select pr.*, v.numorden
from Prodven pr
inner join venta v on pr.numOrdenfk= v.numOrden;

alter table prodven add totalCompra int;
/*consultar cliente de la maxima venta hecha */
/*consultar usuario y cliente de un venta especifica*/
/*consultar los productos que comrpo un cliente especifico*/
/*consultar todos los clientes que han hecho ventas o compras*/
select c.nombrecliente, v.idClienteFK, pr.total
from Venta v
inner join cliente c on c.idCliente = v.idClienteFK
inner join prodven pr on v.numOrden=pr.numOrdenFK
where total= max(total);


/*consultar usuario y cliente de una venta*/
select v.numorden, u.nombreusuario, u.apellidousuario, c.nombrecliente, c.apellidocliente
from venta v
inner join usuario u on v.idusuariofk = u.idusuario
inner join cliente c on v.idclientefk = c.idcliente
where v.numorden = 'ord001'; 


/*consultar los productos que compro un cliente especifico*/
select c.nombrecliente, c.apellidocliente, p.nombreproducto, p.marca, p.precio
from venta v
inner join cliente c on v.idclientefk = c.idcliente
inner join prodven pv on v.numorden = pv.numordenfk
inner join producto p on pv.codigobarrasfk = p.codigobarras
where c.idcliente = 1; 

/*consultar todos los clientes que han hecho una orden*/
select nombrecliente from cliente
inner join venta on cliente.idcliente = venta.idclientefk;

/*Modificaciones 
update tabla set campo='nombrecampo' where condicion */

insert into Cliente (nombrecliente, apellidocliente, direccioncliente, telefono) values ('Tatiana', 'Cabrera', 'Calle 13',3107626845);

select * from Venta;

insert into Producto (codigobarras, nombreProducto, marca, precio) values ('13kg','Pijama bebe', 'offcors',20000);

insert into Venta (numorden, fechacompra, totalcompra, idusuariofk, idclientefk) values ('ord005','2024-09-27',20000,3,5);

update Cliente set fechanacimiento='1985-11-24', telefono='314460691', direccionCliente='Calle 104' where idCliente= 5;

alter table Venta change column idventas idventas varchar(255);

update Venta set idVentas='2024-09-27' where idClienteFK= 5;

/*Eliminaciones
delete from tabla where condicion*/
select * from Cliente;
insert into Cliente (idCliente,nombrecliente, apellidocliente, direccioncliente, telefono,fechanacimiento) values (551,'Tatiana','Cabrera','Calle 104',314460691,'1985-11-24');
update Venta set idClienteFK= 551 where idClienteFK= 5;
select * from Venta;
delete from Cliente where idCliente= 5;
DELIMITER //
CREATE PROCEDURE registarProducto(idProducto int,codigoBarras varchar(15),nombreProducto varchar(15),marca varchar(15),precio float)
BEGIN 
insert into Producto  values (idProducto, codigoBarras, nombreProducto, marca, precio);
END //
DELIMITER ;

DROP PROCEDURE registarProducto;

call registarProducto(7,'23jk','Marcadores','Magistral',2000);
select * from Producto;
/*ELIMINAR: drop procedure registrarProducto*/


update Producto set nombreProducto='Marcador' WHERE codigoBarras=6;

create view consultarCliente as 
select * from Cliente;

select * from consultarCliente;
